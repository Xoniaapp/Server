generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "relationJoins"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id String @id @unique

  name     String?
  username String  @unique

  email    String  @unique
  phone    String? @unique
  password String

  avatar_hash String @unique
  banner_hash String @unique

  banner       String
  avatar       String
  banner_color String?

  // flags
  verified Boolean @default(false)
  two_fa   Boolean @default(false)

  bio      String?
  pronouns String?

  // secrets
  two_fa_key String @unique

  // relationships

  guilds      Guild[]
  messages    Message[]
  attachments Attachment[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user_friend              Friend[]        @relation("user_friend")
  user_friender            Friend[]        @relation("user_friender")
  friend_requests_received FriendRequest[] @relation("friend_requests_receiver_to_users")
  friend_requests_sent     FriendRequest[] @relation("friend_requests_sender_to_users")
  dms_received             DM[]            @relation("dm_receiver_to_users")
  dms_sender               DM[]            @relation("dm_sender_to_users")
  guild_participations     Member[]        @relation("member_to_guilds")

  @@index([id, username, email, avatar_hash, banner_hash])
  @@map("users")
}

// a guild is same as a server
model Guild {
  id String @id @unique

  icon   String?
  banner String?

  icon_hash   String? @unique
  banner_hash String? @unique

  name        String
  description String

  mfa_level          String // todo
  nsfw_level         String // todo
  notification_level String // todo
  verification_level String // todo
  features           String // todo

  // relationships
  channels Channel[]
  members  Member[]  @relation("guild_to_members")
  owner    User      @relation(fields: [owner_id], references: [id], onDelete: Cascade)

  owner_id String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id])
  @@map("guilds")
}

model Channel {
  id String @id @unique

  name String
  type ChannelType

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  is_public Boolean @default(true)
  is_group  Boolean @default(false)
  is_dm     Boolean @default(false)

  messages    Message[]
  attachments Attachment[] // so that we can quickly findout attachments

  guild    Guild?  @relation(fields: [guild_id], references: [id], onDelete: Cascade)
  guild_id String?

  @@index([id])
  @@map("channels")
}

model DM {
  id         String @id @unique
  channel_id String @unique

  is_open Boolean @default(true)

  sender_id   String
  receiver_id String

  receiver User @relation("dm_receiver_to_users", fields: [receiver_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_dm_receiver")
  sender   User @relation("dm_sender_to_users", fields: [sender_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_dm_sender")

  @@index([id, channel_id, is_open, sender_id, receiver_id])
  @@map("dm_channels")
}

model Message {
  id String @id @unique

  content String // the actual text

  channel Channel @relation(fields: [channel_id], references: [id])
  user    User    @relation(fields: [user_id], references: [id])

  channel_id String
  user_id    String // sender_id

  attachments Attachment[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id, channel_id, user_id])
  @@map("messages")
}

model Attachment {
  id String @id @unique

  path String @unique

  name String
  type String
  size String
  hash String @unique

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  message Message @relation(fields: [message_id], references: [id])
  channel Channel @relation(fields: [channel_id], references: [id])
  user    User    @relation(fields: [user_id], references: [id])

  message_id String
  channel_id String
  user_id    String

  @@index([id, message_id, channel_id, user_id])
  @@map("attachments")
}

model Member {
  user_id  String
  guild_id String

  avatar       String?
  avatar_hash  String?
  banner       String?
  banner_hash  String?
  banner_color String?
  name         String?
  pronouns     String?
  bio          String?
  color        String?
  role         String?

  last_seen  DateTime?
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  guild   Guild   @relation("guild_to_members", fields: [guild_id], references: [id], onDelete: Cascade)
  member  User    @relation("member_to_guilds", fields: [user_id], references: [id], onDelete: Cascade)
  userId  String?
  guildId String?

  @@id([user_id, guild_id])
  @@map("members")
}

model Friend {
  user_id   String
  friend_id String

  user   User @relation("user_friend", fields: [friend_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_friends_friends")
  friend User @relation("user_friender", fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_friends_user")

  @@id([user_id, friend_id])
  @@index([user_id, friend_id])
  @@map("friends")
}

model FriendRequest {
  sender_id   String
  receiver_id String

  receiver User @relation("friend_requests_receiver_to_users", fields: [receiver_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_friend_requests")
  sender   User @relation("friend_requests_sender_to_users", fields: [sender_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_friend_requests_user")

  @@id([sender_id, receiver_id])
  @@map("friend_requests")
}

enum ChannelType {
  voice
  text
  announcement
  rules
  system

  @@map("channel_type")
}
